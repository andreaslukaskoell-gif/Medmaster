---
phase: 05-smart-integration
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/components/chapter/InteractiveQuiz.tsx
  - src/components/layout/AppShell.tsx
  - src/components/learning/LevelUpOverlay.tsx
autonomous: true
requirements: [SMART-01, SMART-02, SMART-05, SMART-06, SMART-07]

must_haves:
  truths:
    - "User earns XP on every correct quiz answer"
    - "Second-try mechanic awards 50% XP when user retries after wrong answer"
    - "Hot-Streak bonus (1.25x XP) triggers after 5+ consecutive correct answers"
    - "Level-up overlay appears when XP crosses level boundary (100 XP increments)"
    - "Level-up overlay shows level name (Pflegepraktikant → Medizinstudent → ...)"
  artifacts:
    - path: "src/components/chapter/InteractiveQuiz.tsx"
      provides: "XP award logic with second-try and hot-streak multipliers"
      min_lines: 100
    - path: "src/components/layout/AppShell.tsx"
      provides: "Level-up detection and LevelUpOverlay trigger"
      contains: "useEffect.*getLevelFromXP"
    - path: "src/components/learning/LevelUpOverlay.tsx"
      provides: "Level-up modal with level name display"
      exports: ["LevelUpOverlay"]
  key_links:
    - from: "src/components/chapter/InteractiveQuiz.tsx"
      to: "useStore.addXP()"
      via: "XP calculation in handleAnswerChange"
      pattern: "useStore.*addXP"
    - from: "src/components/layout/AppShell.tsx"
      to: "getLevelFromXP"
      via: "useEffect monitoring xp state"
      pattern: "getLevelFromXP.*xp"
---

<objective>
Integrate XP award system into InteractiveQuiz component with second-try mechanics, hot-streak bonuses, and level-up detection in AppShell.

Purpose: Ensure every quiz answer awards XP consistently, with correct multipliers for difficulty, second attempts, and hot streaks. Users see immediate XP feedback and level-up celebrations.

Output: Working XP flow from quiz answers through level-up overlays, with all multipliers (difficulty, second-try, hot-streak) correctly applied.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-smart-integration/05-CONTEXT.md
@.planning/phases/05-smart-integration/05-RESEARCH.md

# Key Files
@src/components/chapter/InteractiveQuiz.tsx
@src/components/chapter/QuizQuestion.tsx
@src/components/layout/AppShell.tsx
@src/components/learning/LevelUpOverlay.tsx
@src/store/useStore.ts
@src/store/quizSessionStore.ts
@src/lib/xp.ts
@src/lib/progression.ts
</context>

<tasks>

<task type="auto">
  <name>Integrate XP award logic into InteractiveQuiz with second-try and hot-streak multipliers</name>
  <files>src/components/chapter/InteractiveQuiz.tsx</files>
  <action>
Update InteractiveQuiz component to award XP on every quiz answer with correct multipliers:

1. Import dependencies at top of file:
   - `import { useStore } from "@/store/useStore";`
   - `import { useQuizSessionStore } from "@/store/quizSessionStore";`
   - `import { computeXP } from "@/lib/xp";`

2. Add XP logic to handleAnswerChange callback:
   - Calculate base XP using `computeXP({ baseXP: 10, difficultyMultiplier: question.difficulty ?? 1 })`
   - Apply second-try penalty: if `secondTry === true`, multiply XP by 0.5
   - Apply hot-streak bonus: if `useQuizSessionStore.getState().hotStreakActive`, multiply XP by 1.25
   - Round final XP to integer
   - Call `useStore.getState().addXP(finalXP)`

3. Update QuizQuestion callback signature to receive secondTry flag:
   - Change line 73: `onAnswerChange={(isCorrect, secondTry) => handleAnswerChange(index, isCorrect, secondTry)}`
   - Update handleAnswerChange params: `(questionIndex: number, isCorrect: boolean, secondTry?: boolean)`

4. Keep existing functionality:
   - Still call `onAnswer?.(questionIndex, isCorrect)` for parent tracking
   - Still update questionResults state
   - Still call onAllComplete when quiz finishes

Implementation notes:
- Use `question.difficulty` field from SelfTestQuestion interface (fallback to 1 if undefined)
- Check hot-streak state via `useQuizSessionStore.getState().hotStreakActive` (not reactive subscription, just current state)
- Award XP immediately when user selects answer (synchronous, no delay)
- Second-try penalty applies when user clicks "Nochmal versuchen" button after wrong answer
  </action>
  <verify>
Check that InteractiveQuiz.tsx:
- Imports useStore, useQuizSessionStore, computeXP
- handleAnswerChange calls computeXP and addXP
- Applies 0.5x multiplier when secondTry=true
- Applies 1.25x multiplier when hotStreakActive=true
- Passes secondTry parameter from QuizQuestion callback
  </verify>
  <done>
InteractiveQuiz awards XP per question, with correct multipliers for second-try (50% XP) and hot-streak (125% XP).
  </done>
</task>

<task type="auto">
  <name>Add level-up detection and LevelUpOverlay trigger in AppShell</name>
  <files>src/components/layout/AppShell.tsx</files>
  <action>
Update AppShell component to detect level-up events and show LevelUpOverlay:

1. Import dependencies at top of file:
   - `import { useState, useEffect, useRef } from "react";` (add useState, useRef if not present)
   - `import { useStore } from "@/store/useStore";`
   - `import { getLevelFromXP, getLevelName, getFeatureUnlockedAtLevel } from "@/lib/progression";`
   - `import { LevelUpOverlay } from "@/components/learning/LevelUpOverlay";`

2. Add state for level-up tracking (inside AppShell component):
   ```typescript
   const xp = useStore((s) => s.xp);
   const prevXPRef = useRef(xp);
   const [levelUpState, setLevelUpState] = useState<{ level: number; feature: string | null } | null>(null);
   ```

3. Add useEffect for level-up detection:
   ```typescript
   useEffect(() => {
     const prevLevel = getLevelFromXP(prevXPRef.current);
     const newLevel = getLevelFromXP(xp);

     if (newLevel > prevLevel) {
       const feature = getFeatureUnlockedAtLevel(newLevel);
       setLevelUpState({ level: newLevel, feature });

       // Auto-dismiss after 5 seconds
       const timer = setTimeout(() => setLevelUpState(null), 5000);
       return () => clearTimeout(timer);
     }

     prevXPRef.current = xp;
   }, [xp]);
   ```

4. Render LevelUpOverlay in AppShell (add before closing fragment/div):
   ```typescript
   {levelUpState && (
     <LevelUpOverlay
       level={levelUpState.level}
       levelName={getLevelName(levelUpState.level)}
       feature={levelUpState.feature}
       onDismiss={() => setLevelUpState(null)}
     />
   )}
   ```

Implementation notes:
- Use ref to track previous XP (avoids stale closure in effect)
- Only trigger overlay when newLevel > prevLevel (prevents multiple triggers)
- 5-second auto-dismiss allows users to enjoy celebration, then auto-hides
- Manual dismiss via onDismiss callback (user can click to close early)
  </action>
  <verify>
Check that AppShell.tsx:
- Imports getLevelFromXP, getLevelName, getFeatureUnlockedAtLevel, LevelUpOverlay
- Has useEffect that compares prevLevel vs newLevel
- Sets levelUpState when level increases
- Renders LevelUpOverlay with level, levelName, feature props
- Auto-dismisses overlay after 5 seconds
  </verify>
  <done>
AppShell detects XP threshold crossings, shows LevelUpOverlay with level name and feature unlock, auto-dismisses after 5s.
  </done>
</task>

<task type="auto">
  <name>Update LevelUpOverlay to display level name prominently</name>
  <files>src/components/learning/LevelUpOverlay.tsx</files>
  <action>
Verify and update LevelUpOverlay component to display level name from progression.ts:

1. Check interface props (should already exist):
   - `level: number | undefined`
   - `levelName?: string` (or derive from level)
   - `feature?: string | null`
   - `onDismiss: () => void`

2. If levelName prop doesn't exist, add it to interface and derive from level:
   ```typescript
   interface LevelUpOverlayProps {
     level?: number;
     levelName?: string;
     feature?: string | null;
     onDismiss: () => void;
   }

   export function LevelUpOverlay({ level, levelName, feature, onDismiss }: LevelUpOverlayProps) {
     if (!level) return null;
     const displayName = levelName || getLevelName(level); // fallback
     // ... rest of component
   }
   ```

3. Verify rendering logic displays level name:
   - Title should show: "Level {level}" or just level number
   - Subtitle/body should show: {displayName} (e.g., "Assistenzarzt")
   - Feature unlock (if present): "Freigeschaltet: {feature}"

4. Ensure proper styling:
   - Level name text should be large, prominent (text-2xl or text-3xl)
   - Use Framer Motion for animation (already implemented)
   - Sparkle particles animation (should already exist)

Implementation notes:
- If LevelUpOverlay already displays level name correctly, just verify and document in commit
- Don't break existing animations or styling
- getLevelName is imported from @/lib/progression
  </action>
  <verify>
Check that LevelUpOverlay.tsx:
- Accepts level and levelName props
- Displays level name prominently (text-2xl+)
- Shows feature unlock message if feature is provided
- Returns null if level is undefined
  </verify>
  <done>
LevelUpOverlay displays level name (e.g., "Assistenzarzt") and feature unlock clearly, with animations intact.
  </done>
</task>

</tasks>

<verification>
Manual verification steps:

1. Open any BMS chapter with InteractiveQuiz questions (e.g., bio-kap1)
2. Answer a question correctly → verify XP increases in TopBar
3. Answer a question wrong, click "Nochmal versuchen", answer correctly → verify XP increase is 50% of normal
4. Answer 5 questions correctly in a row → verify hot-streak toast appears AND XP is 125% of normal
5. Earn enough XP to cross level boundary (100 XP) → verify LevelUpOverlay appears with level name
6. Wait 5 seconds → verify overlay auto-dismisses
7. Click overlay dismiss button → verify immediate close

Check console for errors, verify XP calculations:
- Base question (difficulty 1): 10 XP
- Hard question (difficulty 1.5): 15 XP
- Second-try correct: 50% of above
- Hot-streak active: 1.25x multiplier on top of difficulty
</verification>

<success_criteria>
- Every quiz answer awards XP immediately via useStore.addXP()
- Second-try mechanic correctly awards 50% XP when secondTry flag is true
- Hot-streak bonus (1.25x) applies when 5+ consecutive correct answers
- Level-up overlay appears on XP threshold crossing (100, 200, 300, ...)
- Level-up overlay displays level name from LEVEL_NAMES array
- Level-up overlay auto-dismisses after 5 seconds
- No duplicate level-up triggers or XP calculation errors
</success_criteria>

<output>
After completion, create `.planning/phases/05-smart-integration/05-01-SUMMARY.md`
</output>
