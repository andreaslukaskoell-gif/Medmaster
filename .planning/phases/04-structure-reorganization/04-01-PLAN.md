---
phase: 04-structure-reorganization
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/data/bmsKapitel/types.ts
  - src/data/bmsKapitel/colors.ts
  - src/data/bmsKapitel/index.ts
autonomous: true
requirements: [STRUCT-01, STRUCT-02]

must_haves:
  truths:
    - "Kapitel interface includes sequence and linkedChapters fields"
    - "Subject colors are defined centrally and reusable across components"
    - "All Biologie chapters have sequence numbers in learning order"
  artifacts:
    - path: "src/data/bmsKapitel/types.ts"
      provides: "Extended Kapitel interface with sequence metadata"
      contains: "sequence?: number"
    - path: "src/data/bmsKapitel/colors.ts"
      provides: "SUBJECT_COLORS map with all 4 subjects"
      exports: ["SUBJECT_COLORS", "getSubjectColors"]
      min_lines: 40
    - path: "src/data/bmsKapitel/index.ts"
      provides: "Updated chapter exports with validation helpers"
      exports: ["validateChapterSequence", "validateSmartLinks"]
  key_links:
    - from: "src/data/bmsKapitel/biologie/index.ts"
      to: "types.ts sequence field"
      via: "sequence metadata on each bioKap"
      pattern: "sequence: \\d+"
---

<objective>
Establish data layer foundation for lernlogische Abfolge by extending the Kapitel type with sequence and smart-link metadata, creating a centralized color system for Premium-Buckets, and applying learning sequence to all Biologie chapters.

Purpose: Enable data-driven chapter ordering and subject theming without hardcoding in components.
Output: Extended type system, color constants, and sequenced Biologie chapters ready for UI integration.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-structure-reorganization/04-RESEARCH.md

# Current type system
@src/data/bmsKapitel/types.ts
@src/data/bmsKapitel/index.ts
@src/data/bmsKapitel/biologie/index.ts

# Existing color usage (to be centralized)
@src/pages/BMS.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend Kapitel interface with sequence and smart-link fields</name>
  <files>src/data/bmsKapitel/types.ts</files>
  <action>
Add three optional fields to the Kapitel interface:

```typescript
export interface Kapitel {
  id: string;
  title: string;
  subject: 'biologie' | 'chemie' | 'physik' | 'mathematik';
  icon: string;
  unterkapitel: Unterkapitel[];
  estimatedTime: string;
  // NEW FIELDS:
  sequence?: number;           // Learning sequence position (1 = first chapter in subject)
  sequenceTitle?: string;      // Short title for roadmap display (e.g., "Zelle" instead of "Die Zelle - Struktur und Funktion")
  linkedChapters?: string[];   // Array of chapter IDs for smart-links (related/prerequisite chapters)
}
```

Add JSDoc comments explaining:
- `sequence` is used for sorting chapters in lernlogische Abfolge (not alphabetically)
- `sequenceTitle` provides compact roadmap labels
- `linkedChapters` enables cross-chapter navigation for related topics

Do NOT modify existing fields or other interfaces.
  </action>
  <verify>
Run `npm run type-check` to ensure TypeScript compilation succeeds with new fields.
Grep for `sequence?:` in types.ts to confirm field addition.
  </verify>
  <done>Kapitel interface includes sequence, sequenceTitle, and linkedChapters optional fields with JSDoc documentation.</done>
</task>

<task type="auto">
  <name>Task 2: Create centralized SUBJECT_COLORS map</name>
  <files>src/data/bmsKapitel/colors.ts</files>
  <action>
Create new file `src/data/bmsKapitel/colors.ts` with Premium-Bucket color definitions for all 4 subjects:

```typescript
/**
 * Premium-Bucket Color System (Phase 4: STRUCT-01)
 *
 * Defines consistent color theming for all BMS subjects:
 * - Biologie: emerald (green)
 * - Chemie: red
 * - Physik: blue
 * - Mathematik: violet
 *
 * Usage:
 * ```tsx
 * import { getSubjectColors } from '@/data/bmsKapitel/colors';
 * const colors = getSubjectColors('biologie');
 * <div className={`${colors.bg} ${colors.bgDark}`}>
 * ```
 */

export const SUBJECT_COLORS = {
  biologie: {
    bg: 'bg-emerald-100',
    bgDark: 'dark:bg-emerald-900/30',
    text: 'text-emerald-700',
    textDark: 'dark:text-emerald-400',
    border: 'border-l-emerald-500',
    button: 'bg-emerald-600 hover:bg-emerald-700',
    progress: 'bg-emerald-500',
    icon: 'text-emerald-600',
  },
  chemie: {
    bg: 'bg-red-100',
    bgDark: 'dark:bg-red-900/30',
    text: 'text-red-700',
    textDark: 'dark:text-red-400',
    border: 'border-l-red-500',
    button: 'bg-red-600 hover:bg-red-700',
    progress: 'bg-red-500',
    icon: 'text-red-600',
  },
  physik: {
    bg: 'bg-blue-100',
    bgDark: 'dark:bg-blue-900/30',
    text: 'text-blue-700',
    textDark: 'dark:text-blue-400',
    border: 'border-l-blue-500',
    button: 'bg-blue-600 hover:bg-blue-700',
    progress: 'bg-blue-500',
    icon: 'text-blue-600',
  },
  mathematik: {
    bg: 'bg-violet-100',
    bgDark: 'dark:bg-violet-900/30',
    text: 'text-violet-700',
    textDark: 'dark:text-violet-400',
    border: 'border-l-violet-500',
    button: 'bg-violet-600 hover:bg-violet-700',
    progress: 'bg-violet-500',
    icon: 'text-violet-600',
  },
} as const;

export type SubjectId = keyof typeof SUBJECT_COLORS;

/**
 * Get color classes for a given subject.
 * Returns color object with bg, text, border, etc. for consistent theming.
 */
export function getSubjectColors(subject: SubjectId) {
  return SUBJECT_COLORS[subject];
}
```

Export SUBJECT_COLORS as const for type safety.
  </action>
  <verify>
Import and call `getSubjectColors('biologie')` in a test script to confirm it returns color object.
Run `npm run type-check` to ensure TypeScript compilation succeeds.
  </verify>
  <done>colors.ts file exists with SUBJECT_COLORS map for all 4 subjects and getSubjectColors helper function.</done>
</task>

<task type="auto">
  <name>Task 3: Apply learning sequence to Biologie chapters</name>
  <files>src/data/bmsKapitel/biologie/index.ts</files>
  <action>
Update biologie/index.ts to add sequence metadata to all 3 existing chapters following the learning order from STRUCT-02:

**Current Biologie chapters:**
- bio-kap1: Die Zelle (kap1-die-zelle-test.ts)
- bio-kap7: Methoden der Genetik (kap7-methoden-der-genetik.ts)
- bio-kap8: Humangenetik (kap8-humangenetik.ts)

**Learning sequence (STRUCT-02):**
1. Zelle → 2. Gewebe → 3. Organe → 4. Frühentwicklung → 5. Genetik → 6. Molekulare Genetik → 7. Methoden → 8. Humangenetik → 9. Ökologie

**Apply sequence:**
```typescript
import type { Kapitel } from '../types';
import { bioKap1 } from './kap1-die-zelle-test';
import { bioKap7 } from './kap7-methoden-der-genetik';
import { bioKap8 } from './kap8-humangenetik';

export const biologieKapitel: Kapitel[] = [
  {
    ...bioKap1,
    sequence: 1,
    sequenceTitle: "Zelle",
    linkedChapters: [], // Will be populated in future plans when Gewebe/Organe chapters exist
  },
  {
    ...bioKap7,
    sequence: 7,
    sequenceTitle: "Methoden",
    linkedChapters: ['bio-kap8'], // Related to Humangenetik
  },
  {
    ...bioKap8,
    sequence: 8,
    sequenceTitle: "Humangenetik",
    linkedChapters: ['bio-kap7'], // Related to Methoden der Genetik
  },
];
```

**Important:** Chapters 2-6 and 9 do not exist yet (Gewebe, Organe, Frühentwicklung, Genetik, Molekulare Genetik, Ökologie). Only apply sequence to existing chapters. Leave gaps in sequence numbers (1, 7, 8) to preserve logical positions for future chapters.
  </action>
  <verify>
Read biologie/index.ts and confirm all 3 chapters have sequence, sequenceTitle, and linkedChapters fields.
Verify sequence numbers match learning order (1, 7, 8).
Run `npm run type-check` to ensure no TypeScript errors.
  </verify>
  <done>All 3 Biologie chapters have sequence metadata in learning order with correct sequence numbers (1, 7, 8).</done>
</task>

<task type="auto">
  <name>Task 4: Add validation helpers to index.ts</name>
  <files>src/data/bmsKapitel/index.ts</files>
  <action>
Add two validation helper functions to index.ts to detect missing sequence metadata and broken smart-links:

```typescript
/**
 * Validates that all chapters in a subject have sequence numbers.
 * Logs warnings for chapters missing sequence metadata.
 * (Phase 4: STRUCT-02 quality gate)
 */
export function validateChapterSequence() {
  const subjects = ['biologie', 'chemie', 'physik', 'mathematik'] as const;
  subjects.forEach(subject => {
    const chapters = getKapitelBySubject(subject);
    const missing = chapters.filter(c => c.sequence === undefined);
    if (missing.length > 0) {
      console.warn(`⚠️ ${subject} missing sequence: ${missing.map(c => c.id).join(', ')}`);
    }
  });
}

/**
 * Validates that linkedChapters references point to existing chapters.
 * Logs warnings for broken smart-links.
 * (Phase 4: STRUCT-05 quality gate)
 */
export function validateSmartLinks() {
  const allIds = new Set(alleKapitel.map(c => c.id));

  alleKapitel.forEach(chapter => {
    if (chapter.linkedChapters && chapter.linkedChapters.length > 0) {
      chapter.linkedChapters.forEach(linkedId => {
        if (!allIds.has(linkedId)) {
          console.warn(`❌ Chapter ${chapter.id} links to missing ${linkedId}`);
        }
      });
    }
  });
}
```

Add these functions after the existing helper functions (getKapitelBySubject, getKapitelById, findChapterByUnterkapitelId).

Export both functions in the barrel export at the bottom of the file.
  </action>
  <verify>
Run `npm run type-check` to ensure compilation succeeds.
Grep for `export function validateChapterSequence` to confirm function exists.
Call `validateChapterSequence()` in browser console to verify it runs without errors.
  </verify>
  <done>index.ts includes validateChapterSequence and validateSmartLinks helper functions and exports them.</done>
</task>

</tasks>

<verification>
Run all verifications:
```bash
npm run type-check
grep -n "sequence?:" src/data/bmsKapitel/types.ts
grep -n "SUBJECT_COLORS" src/data/bmsKapitel/colors.ts
grep -n "sequence: [178]" src/data/bmsKapitel/biologie/index.ts
grep -n "validateChapterSequence" src/data/bmsKapitel/index.ts
```

All should succeed without errors.
</verification>

<success_criteria>
- [ ] Kapitel interface extended with sequence, sequenceTitle, linkedChapters fields
- [ ] SUBJECT_COLORS map created with all 4 Premium-Bucket colors
- [ ] All 3 Biologie chapters have sequence metadata (1, 7, 8)
- [ ] Validation helpers exist and can be called without errors
- [ ] TypeScript compilation succeeds with no errors
- [ ] No existing code broken by type changes
</success_criteria>

<output>
After completion, create `.planning/phases/04-structure-reorganization/04-01-SUMMARY.md`
</output>
