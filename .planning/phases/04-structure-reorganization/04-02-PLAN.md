---
phase: 04-structure-reorganization
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src/pages/BMS.tsx
  - src/components/chapter/FachRoadmap.tsx
  - src/pages/BMSKapitelView.tsx
autonomous: false
requirements: [STRUCT-01, STRUCT-02, STRUCT-03, STRUCT-04, STRUCT-05]

must_haves:
  truths:
    - "Chapters display in learning sequence (not file import order)"
    - "Subject colors applied consistently from SUBJECT_COLORS map"
    - "Fach overview shows visual roadmap with sequence numbers"
    - "Chapter detail shows smart-links to related chapters"
    - "URL structure /bms/:fach/:kapitel works correctly"
  artifacts:
    - path: "src/components/chapter/FachRoadmap.tsx"
      provides: "Visual roadmap component for learning sequence"
      exports: ["FachRoadmap"]
      min_lines: 50
    - path: "src/pages/BMS.tsx"
      provides: "Updated subject view with SUBJECT_COLORS and sorting"
      contains: "SUBJECT_COLORS"
    - path: "src/pages/BMSKapitelView.tsx"
      provides: "Smart-links section in chapter detail"
      contains: "linkedChapters"
  key_links:
    - from: "src/pages/BMS.tsx"
      to: "src/data/bmsKapitel/colors.ts"
      via: "import SUBJECT_COLORS"
      pattern: "import.*SUBJECT_COLORS.*from.*colors"
    - from: "src/components/chapter/FachRoadmap.tsx"
      to: "Kapitel.sequence field"
      via: "sort by sequence"
      pattern: "\\.sort.*sequence"
---

<objective>
Integrate lernlogische Abfolge and Premium-Bucket colors into UI by replacing hardcoded colors with SUBJECT_COLORS, sorting chapters by sequence in all views, creating a visual FachRoadmap component for overview pages, and adding smart-links to chapter detail views.

Purpose: Make data layer enhancements visible in user-facing UI with consistent theming and logical chapter ordering.
Output: Visual roadmap, sorted chapter lists, smart-links, and centralized color theming across all BMS pages.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-structure-reorganization/04-RESEARCH.md
@.planning/phases/04-structure-reorganization/04-01-SUMMARY.md

# New data layer (from Plan 01)
@src/data/bmsKapitel/types.ts
@src/data/bmsKapitel/colors.ts
@src/data/bmsKapitel/biologie/index.ts

# UI to update
@src/pages/BMS.tsx
@src/pages/BMSKapitelView.tsx

# Existing patterns
@src/components/chapter/MerksatzBox.tsx
@src/components/chapter/QuizQuestion.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace hardcoded colors in BMS.tsx with SUBJECT_COLORS import</name>
  <files>src/pages/BMS.tsx</files>
  <action>
Update BMS.tsx to use centralized SUBJECT_COLORS instead of hardcoded color definitions in the subjects array:

1. **Add import at top of file:**
```typescript
import { SUBJECT_COLORS, getSubjectColors } from '@/data/bmsKapitel/colors';
```

2. **Replace subjects array** (currently lines 67-108) with version that references SUBJECT_COLORS:
```typescript
const subjects = [
  {
    id: "biologie" as const,
    label: "Biologie",
    icon: Dna,
    colors: SUBJECT_COLORS.biologie, // Use centralized colors
    description: "Lebewesen, Zellen, Genetik, Evolution"
  },
  {
    id: "chemie" as const,
    label: "Chemie",
    icon: Atom,
    colors: SUBJECT_COLORS.chemie,
    description: "Periodensystem, Bindungen, Reaktionen"
  },
  {
    id: "physik" as const,
    label: "Physik",
    icon: Zap,
    colors: SUBJECT_COLORS.physik,
    description: "Mechanik, Elektrizität, Wellen, Optik"
  },
  {
    id: "mathematik" as const,
    label: "Mathematik",
    icon: Calculator,
    colors: SUBJECT_COLORS.mathematik,
    description: "Algebra, Analysis, Geometrie, Trigonometrie"
  },
] as const;
```

3. **Update color usage in JSX** - replace all instances of destructured color properties with `colors.` prefix:
   - `color` → `colors.bg} ${colors.bgDark} ${colors.text} ${colors.textDark`
   - `active` → `colors.button`
   - `progress` → `colors.progress`
   - `border` → `colors.border`

4. **Add chapter sorting** - find where `chaptersForSelectedSubject` is mapped over (around line 400+), wrap in useMemo with sort:
```typescript
const sortedChapters = useMemo(() => {
  if (!Array.isArray(chaptersForSelectedSubject)) return [];
  return [...chaptersForSelectedSubject].sort((a, b) => {
    const aSeq = a.sequence ?? 999;
    const bSeq = b.sequence ?? 999;
    return aSeq - bSeq;
  });
}, [chaptersForSelectedSubject]);
```

Then replace all `.map()` iterations over `chaptersForSelectedSubject` with `sortedChapters.map()`.

**Important:** Do NOT remove existing functionality - only replace color definitions and add sorting. Keep all progress tracking, navigation, and loading states intact.
  </action>
  <verify>
1. Run `npm run type-check` to ensure TypeScript compilation succeeds
2. Start dev server with `npm run dev` and navigate to /bms/biologie
3. Verify chapters appear in order: Zelle (1), Methoden (7), Humangenetik (8)
4. Verify emerald colors still display correctly (no visual regression)
  </verify>
  <done>BMS.tsx uses SUBJECT_COLORS import, chapters sort by sequence field, and all subject colors reference centralized map.</done>
</task>

<task type="auto">
  <name>Task 2: Create FachRoadmap visual component</name>
  <files>src/components/chapter/FachRoadmap.tsx</files>
  <action>
Create new component `src/components/chapter/FachRoadmap.tsx` that displays a horizontal learning path with sequence numbers:

```typescript
import React from 'react';
import { motion } from 'framer-motion';
import type { Kapitel } from '@/data/bmsKapitel/types';
import { getSubjectColors, type SubjectId } from '@/data/bmsKapitel/colors';
import { ArrowRight } from 'lucide-react';

interface FachRoadmapProps {
  /** All chapters for this subject */
  chapters: Kapitel[];
  /** Currently active chapter ID (highlighted in roadmap) */
  currentChapterId?: string;
  /** Callback when user clicks a chapter in roadmap */
  onSelectChapter?: (chapterId: string) => void;
}

/**
 * FachRoadmap - Visual learning sequence for a subject
 *
 * Displays chapters in lernlogische Abfolge (learning order) with:
 * - Sequence numbers (1, 2, 3...)
 * - Short titles (sequenceTitle fallback to title)
 * - Arrow connectors between chapters
 * - Current chapter highlighted
 * - Subject-specific color theming
 *
 * Phase 4: STRUCT-02, STRUCT-03
 */
export function FachRoadmap({ chapters, currentChapterId, onSelectChapter }: FachRoadmapProps) {
  if (chapters.length === 0) return null;

  const subject = chapters[0]?.subject;
  if (!subject) return null;

  const colors = getSubjectColors(subject as SubjectId);

  // Sort by sequence (chapters without sequence appear at end)
  const sorted = [...chapters].sort((a, b) => {
    const aSeq = a.sequence ?? 999;
    const bSeq = b.sequence ?? 999;
    return aSeq - bSeq;
  });

  return (
    <motion.div
      initial={{ opacity: 0, y: 10 }}
      animate={{ opacity: 1, y: 0 }}
      transition={{ duration: 0.3 }}
      className={`p-6 rounded-lg border-l-4 ${colors.border} ${colors.bg} ${colors.bgDark}`}
    >
      <h3 className={`font-semibold ${colors.text} ${colors.textDark} mb-4 flex items-center gap-2`}>
        Lernpfad
      </h3>

      <div className="flex items-center gap-2 overflow-x-auto pb-2">
        {sorted.map((chapter, idx) => (
          <React.Fragment key={chapter.id}>
            <motion.button
              whileHover={{ scale: 1.05 }}
              whileTap={{ scale: 0.98 }}
              onClick={() => onSelectChapter?.(chapter.id)}
              className={`px-3 py-2 rounded-md whitespace-nowrap text-sm font-medium transition ${
                currentChapterId === chapter.id
                  ? `${colors.button} text-white shadow-md`
                  : 'bg-white/50 dark:bg-slate-700/50 hover:bg-white/70 dark:hover:bg-slate-700/70'
              }`}
            >
              {chapter.sequence ? `${chapter.sequence}. ` : ''}
              {chapter.sequenceTitle || chapter.title}
            </motion.button>

            {idx < sorted.length - 1 && (
              <ArrowRight className="w-4 h-4 text-slate-400 dark:text-slate-500 flex-shrink-0" />
            )}
          </React.Fragment>
        ))}
      </div>
    </motion.div>
  );
}
```

**Key features:**
- Framer Motion animations (already used in Phase 3 MerksatzBox)
- Subject-specific theming via getSubjectColors
- Horizontal scroll for mobile (overflow-x-auto)
- Active chapter highlighted with button color
- Sequence numbers displayed if present
- Fallback to full title if sequenceTitle missing
  </action>
  <verify>
1. Run `npm run type-check` to ensure component compiles
2. Import FachRoadmap in BMS.tsx (don't render yet, just verify import works)
3. Check that ArrowRight icon imports from lucide-react
  </verify>
  <done>FachRoadmap.tsx component exists and exports FachRoadmap with visual roadmap UI.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate FachRoadmap into BMS.tsx subject detail view</name>
  <files>src/pages/BMS.tsx</files>
  <action>
Add FachRoadmap component to BMS.tsx subject detail view (when a subject is selected but no chapter is active):

1. **Add import at top:**
```typescript
import { FachRoadmap } from '@/components/chapter/FachRoadmap';
```

2. **Find the subject detail rendering section** (around line 450-550, where chaptersForSelectedSubject is rendered). This is the section that shows:
   - Subject title + icon
   - "N Kapitel mit M Unterkapiteln" text
   - Progress bar
   - Chapter list

3. **Insert FachRoadmap BEFORE the chapter list**, after the progress bar:
```typescript
{/* Visual Learning Roadmap - Phase 4: STRUCT-03 */}
{sortedChapters.length > 0 && (
  <FachRoadmap
    chapters={sortedChapters}
    currentChapterId={undefined} // No chapter active in overview
    onSelectChapter={(chapterId) => {
      const chapter = sortedChapters.find(c => c.id === chapterId);
      if (chapter) {
        setActiveKapitel(chapter);
        navigate(pathForChapter(selectedSubject, chapterId));
      }
    }}
  />
)}
```

4. Add margin spacing (mt-6) to ensure visual separation from progress bar above and chapter list below.

**Important:** Keep all existing BMS.tsx functionality intact - only ADD the FachRoadmap component, don't remove or modify existing chapter list, progress tracking, or navigation logic.
  </action>
  <verify>
1. Run `npm run dev` and navigate to /bms/biologie
2. Verify FachRoadmap displays with 3 buttons: "1. Zelle", "7. Methoden", "8. Humangenetik"
3. Click "1. Zelle" in roadmap and verify it navigates to /bms/biologie/bio-kap1
4. Verify emerald color theming matches Biologie subject
  </verify>
  <done>FachRoadmap appears in Biologie overview with clickable sequence buttons that navigate to chapters.</done>
</task>

<task type="auto">
  <name>Task 4: Add smart-links section to BMSKapitelView.tsx</name>
  <files>src/pages/BMSKapitelView.tsx</files>
  <action>
Add "Verwandte Kapitel" (Related Chapters) section to BMSKapitelView.tsx that displays linkedChapters as navigable cards:

1. **Add imports at top:**
```typescript
import { getSubjectColors } from '@/data/bmsKapitel/colors';
import { getKapitelById } from '@/data/bmsKapitel';
import { ArrowRight } from 'lucide-react';
```

2. **Find the main chapter content rendering** (around line 200-300, after quiz/merksätze sections, before navigation buttons).

3. **Add smart-links section BEFORE the bottom navigation** (Zurück/Weiter buttons):
```typescript
{/* Smart-Links to Related Chapters - Phase 4: STRUCT-05 */}
{kapitel.linkedChapters && kapitel.linkedChapters.length > 0 && (() => {
  const colors = getSubjectColors(kapitel.subject);
  const linkedKapitelList = kapitel.linkedChapters
    .map(id => getKapitelById(id))
    .filter((k): k is Kapitel => k !== undefined);

  if (linkedKapitelList.length === 0) return null;

  return (
    <div className="space-y-3 mt-8 pt-6 border-t border-slate-200 dark:border-slate-700">
      <h3 className="font-semibold text-midnight dark:text-slate-100 flex items-center gap-2">
        <ArrowRight className={`w-5 h-5 ${colors.icon}`} />
        Verwandte Kapitel
      </h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        {linkedKapitelList.map(linkedKap => (
          <button
            key={linkedKap.id}
            onClick={() => onGoToChapter(linkedKap.id, 0)}
            className={`text-left p-4 rounded-lg border-l-4 ${colors.border} ${colors.bg} ${colors.bgDark} hover:shadow-md transition-all duration-200`}
          >
            <div className={`font-medium ${colors.text} ${colors.textDark}`}>
              {linkedKap.sequenceTitle || linkedKap.title}
            </div>
            <div className="text-sm text-slate-600 dark:text-slate-400 mt-1">
              {linkedKap.subject} • {linkedKap.estimatedTime}
            </div>
          </button>
        ))}
      </div>
    </div>
  );
})()}
```

**Key features:**
- Only renders if linkedChapters exists and has items
- Resolves chapter IDs to full Kapitel objects via getKapitelById
- Subject-specific theming via getSubjectColors
- Grid layout (1 col mobile, 2 cols desktop)
- Clicking a related chapter navigates via onGoToChapter callback
- Shows sequenceTitle if available, falls back to full title

**Important:** Do NOT modify existing BMSKapitelView functionality - only ADD this section. Keep all existing quiz, merksätze, navigation, and XP logic intact.
  </action>
  <verify>
1. Run `npm run dev` and navigate to /bms/biologie/bio-kap7 (Methoden der Genetik)
2. Scroll to bottom before Zurück/Weiter buttons
3. Verify "Verwandte Kapitel" section appears with link to "8. Humangenetik"
4. Click the Humangenetik card and verify it navigates to bio-kap8
5. On bio-kap8, verify it shows link back to bio-kap7
  </verify>
  <done>BMSKapitelView shows "Verwandte Kapitel" section with navigable cards for all chapters with linkedChapters metadata.</done>
</task>

</tasks>

<checkpoint type="checkpoint:human-verify" gate="blocking">
  <what-built>
Phase 4 Structure Reorganization UI integration complete:
- SUBJECT_COLORS centralized color system applied to BMS.tsx
- FachRoadmap component showing learning sequence
- Smart-links between related chapters in BMSKapitelView
- All chapters sorting by sequence field
  </what-built>
  <how-to-verify>
1. Start dev server: `npm run dev`

2. Test BMS Overview (/bms):
   - Visit http://localhost:5173/bms
   - Verify all 4 subjects show correct colors (emerald/red/blue/violet)
   - Click "Biologie" card

3. Test Fach Overview (/bms/biologie):
   - Verify FachRoadmap appears showing: "1. Zelle", "7. Methoden", "8. Humangenetik"
   - Verify chapter list below also shows same order (not alphabetical)
   - Verify emerald theming consistent (roadmap, cards, progress bar)
   - Click "1. Zelle" in roadmap

4. Test Chapter Detail (/bms/biologie/bio-kap1):
   - Verify chapter content loads
   - Scroll to bottom (no linkedChapters for kap1, so no smart-links section expected)
   - Navigate to Methoden: /bms/biologie/bio-kap7

5. Test Smart-Links (/bms/biologie/bio-kap7):
   - Scroll to bottom before navigation buttons
   - Verify "Verwandte Kapitel" section appears
   - Verify link to "8. Humangenetik" displays
   - Click Humangenetik card
   - Verify navigates to bio-kap8
   - On bio-kap8, verify link back to "7. Methoden" appears

6. Test URL Structure (STRUCT-04):
   - Manually visit /bms/chemie (should show empty or minimal content - OK)
   - Visit /bms/biologie/bio-kap1 (should load Zelle chapter)
   - Visit /bms/biologie/bio-kap8 (should load Humangenetik)

Expected outcome:
- Learning sequence visible in all views (1, 7, 8 order)
- Premium-Bucket colors consistent across all components
- Smart-links functional and navigable
- No console errors
- No layout glitches or visual regressions
  </how-to-verify>
  <resume-signal>Type "approved" if all verification steps pass, or describe any issues found.</resume-signal>
</checkpoint>

<verification>
Manual testing checklist:

**BMS Overview (/bms):**
- [ ] All 4 subjects display with correct Premium-Bucket colors (emerald/red/blue/violet)
- [ ] Clicking Biologie shows subject detail

**Biologie Overview (/bms/biologie):**
- [ ] FachRoadmap displays with 3 chapters in order: "1. Zelle", "7. Methoden", "8. Humangenetik"
- [ ] Chapter list below roadmap also shows chapters in same order (1, 7, 8)
- [ ] Clicking roadmap button navigates to correct chapter
- [ ] Emerald color theming consistent across roadmap, cards, progress bar

**Chapter Detail (/bms/biologie/bio-kap7):**
- [ ] "Verwandte Kapitel" section appears before bottom navigation
- [ ] Shows link to "8. Humangenetik"
- [ ] Clicking card navigates to bio-kap8
- [ ] On bio-kap8, shows link back to "7. Methoden"

**URL Structure (STRUCT-04):**
- [ ] /bms works (subject grid)
- [ ] /bms/biologie works (subject overview with roadmap)
- [ ] /bms/biologie/bio-kap1 works (chapter detail)
- [ ] /bms/biologie/bio-kap7 works
- [ ] /bms/biologie/bio-kap8 works

Run TypeScript: `npm run type-check` - should succeed with no errors.
</verification>

<success_criteria>
- [ ] SUBJECT_COLORS imported and used in BMS.tsx (no hardcoded colors)
- [ ] Chapters sort by sequence field in all views
- [ ] FachRoadmap component renders in subject overview
- [ ] Smart-links section renders in chapter detail for chapters with linkedChapters
- [ ] URL structure /bms/:fach/:kapitel works without regressions
- [ ] All 4 Premium-Bucket colors applied consistently
- [ ] No TypeScript compilation errors
- [ ] No runtime errors in browser console
</success_criteria>

<output>
After completion, create `.planning/phases/04-structure-reorganization/04-02-SUMMARY.md`

Then pause for human verification checkpoint.
</output>
